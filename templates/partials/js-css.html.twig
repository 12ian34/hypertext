{# Basic Refs #}
{% set structure = config.themes.hypertext.structure %}
{% set style = config.themes.hypertext.style %}
{% set stylesheets = ['air', 'latex', 'marx', 'sakura-dark-solarized', 'sakura-dark', 'sakura-earthly', 'sakura-vader',
                      'sakura', 'stylize', 'tacit', 'tufte', 'w3c-chocolate', 'w3c-midnight', 'w3c-modernist', 'w3c-oldstyle',
                      'w3c-steely', 'w3c-swiss', 'w3c-traditional', 'w3c-ultramarine', 'water-dark', 'water-light', 'writ',
                      'yorha'] %}

{# Allow CSS and JS Logic #}
{% set allowCSS = page.header.allowCSS == 'enabled' or
                    (page.header.allowCSS|default('default') == 'default' and 
                     style.allowCSS == '1') %}
{% set allowJS  = page.header.allowJS  == 'enabled' or
                    (page.header.allowJS|default('default') == 'default' and 
                     style.allowJS == '1') %}

{% block stylehseets %}

{# Set a stylesheet from URI or style config #}
{% set stylesheet = uri.query('theme')|default(style.stylesheet) %}
{# Numbers in the query need to be mapped #}
{% if stylesheet matches '/^\\d+$/' %}
    {% set stylesheet = stylesheets[stylesheet] %}
{% endif %}

{# Add the stylesheet #}
{# TODO: Add sourcing from unpkg rather than locally #}
{% if stylesheet != 'default' %}
    {% if style.includeType == 'inline' %}
        {# User *explicitly* wants it imported in style tags #}
        <style>{{ include('theme://css/' ~ stylesheet ~ '.css') }}</style>
    {% elseif not style.allowCSS %}
        {# User wants it via href, but doesn't have CSS pipeline running #}
        <link href="{{ url('theme://css/'~stylesheet~'.css') }}" rel="stylesheet" />
    {% else %}
        {# User wants it href and is allowing CSS #}
        {% do assets.addCss('theme://css/'~stylesheet~'.css') %}
    {% endif %}
{% endif %}

{# Regular CSS/JS includes #}
{% if allowCSS %}
    {{ assets.css()|raw }}
{% endif %}
{% endblock %}

{% block javascripts %}
    {% if allowJS %}
    {{ assets.js()|raw }}
    {% endif %}
{% endblock %} 

{# Add custom styles (if avialable) after everything, so the user can adjust #}
{% if layout.width != undefined and 
      layout.configuration != undefined and 
      style.customCSS != undefined %}
<style>
body {
{{ layout.width ? "max-width: #{layout.width}px;" : ""}}
{{ layout.configuration ? "margin: auto;" : ""}}
{{ style.customCSS }}
}
</style>
{% endif %}